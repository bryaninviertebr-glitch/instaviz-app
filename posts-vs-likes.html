<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts vs Likes - InstaViz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #FFFD00;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .highlight {
            color: var(--accent);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .back-btn {
            display: inline-block;
            margin-bottom: 1rem;
            padding: 0.7rem 1.5rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: var(--accent);
            color: black;
            border-color: var(--accent);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .chart-section {
            min-height: 600px;
        }

        #postsVsLikesPlot {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1rem;
            min-height: 600px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        /* Info Panel */
        .info-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            height: fit-content;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            text-align: center;
            position: relative;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 253, 0, 0.2);
            color: var(--accent);
            font-size: 0.75rem;
            font-weight: bold;
            cursor: help;
            position: relative;
            transition: all 0.3s;
        }

        .info-icon:hover {
            background: var(--accent);
            color: black;
            transform: scale(1.1);
        }

        .info-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            border: 1px solid var(--accent);
            z-index: 1000;
            font-weight: normal;
            text-transform: none;
            letter-spacing: normal;
            line-height: 1.4;
            max-width: 250px;
            white-space: normal;
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--accent);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent);
        }

        .info-section {
            margin-top: 2rem;
        }

        .info-section h3 {
            color: var(--accent);
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .info-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .info-item {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .info-item-label {
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .info-item-value {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .info-description {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Top Performers Table */
        .top-performers {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .top-performers h2 {
            color: var(--accent);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .elite-stats {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .elite-stats strong {
            color: var(--accent);
        }

        .performers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .performers-table th {
            background: rgba(255, 253, 0, 0.1);
            color: var(--accent);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--glass-border);
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }

        .performers-table th:hover {
            background: rgba(255, 253, 0, 0.2);
        }

        .performers-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .performers-table tr:hover {
            background: rgba(255, 253, 0, 0.05);
        }

        .performers-table .caption-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-secondary);
        }

        .performers-table .ratio-cell {
            color: #00FF64;
            font-weight: 600;
        }

        .performers-table .link-cell a {
            color: #6496FF;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.85rem;
        }

        .performers-table .link-cell a:hover {
            color: var(--accent);
        }

        .bin-header {
            transition: all 0.3s;
            user-select: none;
        }

        .bin-header:hover {
            background: rgba(255, 253, 0, 0.15) !important;
        }

        /* Filters Panel */
        .filters-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input,
        .filter-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.7rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .filter-input:focus,
        .filter-select:focus {
            border-color: var(--accent);
        }

        .filter-select option {
            background: #1a1a1a;
            color: white;
        }

        .filter-slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .filter-slider::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 253, 0, 0.5);
            transition: all 0.3s;
        }

        .filter-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(255, 253, 0, 0.8);
        }

        .filter-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 253, 0, 0.5);
        }

        .slider-value {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.95rem;
            margin-top: 0.3rem;
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            grid-column: 1 / -1;
        }

        .filter-btn {
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .filter-btn.primary {
            background: var(--accent);
            color: black;
        }

        .filter-btn.primary:hover {
            filter: brightness(0.9);
            transform: translateY(-2px);
        }

        .filter-btn.secondary {
            background: var(--glass-bg);
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
        }

        .filter-btn.secondary:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Branding Styles */
        .app-footer {
            margin-top: 4rem;
            padding: 2rem;
            text-align: center;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }

        .footer-branding {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .footer-branding strong {
            color: var(--accent);
            font-weight: 600;
        }

        .footer-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.6;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .footer-meta span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .app-footer:hover .footer-branding strong {
            text-shadow: 0 0 10px var(--accent);
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="/" class="back-btn">‚Üê Volver al Dashboard</a>

        <header>
            <h1>Posts vs <span class="highlight">Likes</span></h1>
            <p class="subtitle">An√°lisis de Frecuencia de Engagement</p>
        </header>

        <!-- Business Group Selector -->
        <div id="groupSelectorContainer" class="bg-selector-wrapper"></div>

        <!-- Filters Panel -->
        <div class="filters-panel">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="filterOwner">üë§ Conta</label>
                    <select id="filterOwner" class="filter-select">
                        <option value="">Todos os usu√°rios</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="filterDateFrom">üìÖ Data Inicial</label>
                    <input type="date" id="filterDateFrom" class="filter-input">
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="filterDateTo">üìÖ Data Final</label>
                    <input type="date" id="filterDateTo" class="filter-input">
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="filterTopPercent">üèÜ Melhor Desempenho</label>
                    <input type="range" id="filterTopPercent" class="filter-slider" min="10" max="100" value="100"
                        step="10">
                    <div class="slider-value">Top <span id="topPercentValue">100</span>%</div>
                </div>

                <div class="filter-actions">
                    <button id="applyFiltersBtn" class="filter-btn primary">Aplicar Filtros</button>
                    <button id="clearFiltersBtn" class="filter-btn secondary">Limpar</button>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="chart-section">
                <div id="postsVsLikesPlot">
                    <div class="loading">Generando gr√°fico...</div>
                </div>

                <!-- Top Performers Table -->
                <div class="top-performers" id="topPerformers">
                    <h2>üèÜ Top Performers - Posts Destacados</h2>
                    <div class="elite-stats" id="eliteStats">Cargando...</div>
                    <div style="overflow-x: auto;">
                        <table class="performers-table" id="performersTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)">Fecha ‚Üï</th>
                                    <th onclick="sortTable(1)">Likes ‚Üï</th>
                                    <th onclick="sortTable(2)">Comentarios ‚Üï</th>
                                    <th onclick="sortTable(3)">Ratio ‚Üï</th>
                                    <th onclick="sortTable(4)">Owner ‚Üï</th>
                                    <th>URL</th>
                                    <th>Caption</th>
                                </tr>
                            </thead>
                            <tbody id="performersBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--text-secondary);">Cargando
                                        datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <aside class="info-panel">
                <div class="stats-grid" id="statsPanel">
                    <!-- Stats will be populated by JavaScript -->
                </div>

                <div class="info-section">
                    <h3>üìä Informaci√≥n del An√°lisis</h3>
                    <div class="info-content" id="infoContent">
                        <!-- Info will be populated by JavaScript -->
                    </div>
                </div>
            </aside>
        </div>

        <!-- Footer Branding -->
        <footer class="app-footer">
            <p class="footer-branding">Created by <strong>Bryan Orellana</strong></p>
            <div class="footer-meta">
                <span>üìä Instagram Analytics</span>
                <span>¬© 2026</span>
                <span>v1.0</span>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="data-service.js"></script>
    <script src="business-groups.js"></script>
    <script>
        let allPosts = [];
        let filteredPosts = [];

        async function loadData() {
            try {
                // Cargar datos desde Supabase
                const data = await DataService.loadAllPosts();
                allPosts = data;

                // Init business groups
                if (window.BusinessGroups) {
                    await BusinessGroups.init('groupSelectorContainer', () => {
                        filteredPosts = BusinessGroups.filterPosts(allPosts);
                        populateOwnerFilter();
                        clearFilters();
                    });
                    filteredPosts = BusinessGroups.filterPosts(allPosts);
                } else {
                    filteredPosts = [...allPosts];
                }

                populateOwnerFilter();
                setupFilterListeners();
                generateChart();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('postsVsLikesPlot').innerHTML =
                    '<div class="loading">Error al cargar los datos</div>';
            }
        }

        function populateOwnerFilter() {
            const owners = new Set();
            const posts = filteredPosts.length ? filteredPosts : allPosts;
            posts.forEach(post => {
                const owner = post.ownerUsername || post.ownerFullName;
                if (owner) owners.add(owner);
            });

            const select = document.getElementById('filterOwner');
            select.innerHTML = '<option value="">Todos os usu\u00e1rios</option>';
            Array.from(owners).sort().forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                select.appendChild(option);
            });
        }

        function setupFilterListeners() {
            const slider = document.getElementById('filterTopPercent');
            const sliderValue = document.getElementById('topPercentValue');

            slider.addEventListener('input', () => {
                sliderValue.textContent = slider.value;
            });

            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        }

        function applyFilters() {
            const owner = document.getElementById('filterOwner').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const topPercent = parseInt(document.getElementById('filterTopPercent').value);

            // Start with group-filtered posts
            let filtered = [...filteredPosts];

            // Filter by owner
            if (owner) {
                filtered = filtered.filter(post => {
                    const postOwner = post.ownerUsername || post.ownerFullName;
                    return postOwner === owner;
                });
            }

            // Filter by date range
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(post => new Date(post.timestamp) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(post => new Date(post.timestamp) <= toDate);
            }

            // Filter by top percentage
            if (topPercent < 100) {
                filtered.sort((a, b) => (b.likesCount || 0) - (a.likesCount || 0));
                const cutoff = Math.ceil(filtered.length * (topPercent / 100));
                filtered = filtered.slice(0, cutoff);
            }

            filteredPosts = filtered;
            generateChart();
        }

        function clearFilters() {
            document.getElementById('filterOwner').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterTopPercent').value = '100';
            document.getElementById('topPercentValue').textContent = '100';

            filteredPosts = window.BusinessGroups ? BusinessGroups.filterPosts(allPosts) : [...allPosts];
            populateOwnerFilter(filteredPosts);
            generateChart();
        }

        function generateChart() {
            // Agrupar posts por rangos de likes
            const likesData = filteredPosts
                .map(post => Number(post.likesCount) || 0)
                .filter(likes => likes > 0)
                .sort((a, b) => a - b);

            const n = likesData.length;
            const min = Math.min(...likesData);
            const max = Math.max(...likesData);
            const mean = likesData.reduce((sum, val) => sum + val, 0) / n;
            const median = n % 2 === 0
                ? (likesData[n / 2 - 1] + likesData[n / 2]) / 2
                : likesData[Math.floor(n / 2)];

            // Calcular desviaci√≥n est√°ndar
            const variance = likesData.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / n;
            const stdDev = Math.sqrt(variance);

            // Mostrar estad√≠sticas principales
            document.getElementById('statsPanel').innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">
                        Total Posts
                        <span class="info-icon">
                            ‚ÑπÔ∏è
                            <span class="info-tooltip">Cantidad total de posts analizados en el gr√°fico.</span>
                        </span>
                    </div>
                    <div class="stat-value">${n.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">
                        Media
                        <span class="info-icon">
                            ‚ÑπÔ∏è
                            <span class="info-tooltip">Promedio de likes por post.</span>
                        </span>
                    </div>
                    <div class="stat-value">${formatNumber(mean)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">
                        Mediana
                        <span class="info-icon">
                            ‚ÑπÔ∏è
                            <span class="info-tooltip">Valor central que divide los posts en dos mitades iguales.</span>
                        </span>
                    </div>
                    <div class="stat-value">${formatNumber(median)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">
                        Desv. Est.
                        <span class="info-icon">
                            ‚ÑπÔ∏è
                            <span class="info-tooltip">Medida de dispersi√≥n de los likes.</span>
                        </span>
                    </div>
                    <div class="stat-value">${formatNumber(stdDev)}</div>
                </div>
            `;

            // Mostrar informaci√≥n detallada
            document.getElementById('infoContent').innerHTML = `
                <div class="info-item">
                    <div class="info-item-label">Rango de Likes</div>
                    <div class="info-item-value">${formatNumber(min)} - ${formatNumber(max)}</div>
                    <div class="info-description">Valor m√≠nimo y m√°ximo de likes observados</div>
                </div>
                <div class="info-item">
                    <div class="info-item-label">Interpretaci√≥n</div>
                    <div class="info-description">
                        Este gr√°fico muestra la frecuencia de posts para cada rango de likes.
                        Las barras m√°s altas indican rangos de likes m√°s comunes.
                    </div>
                </div>
            `;

            // Crear histograma (cantidad de posts vs likes)
            const histogramTrace = {
                x: likesData,
                type: 'histogram',
                name: 'Cantidad de Posts',
                marker: {
                    color: 'rgba(255, 253, 0, 0.6)',
                    line: {
                        color: 'rgba(255, 253, 0, 0.8)',
                        width: 1
                    }
                },
                opacity: 0.75,
                nbinsx: 30
            };

            const layout = {
                title: {
                    text: 'Frecuencia de Posts por Cantidad de Likes',
                    font: {
                        color: '#ffffff',
                        size: 20
                    }
                },
                xaxis: {
                    title: {
                        text: 'Cantidad de Likes',
                        font: { color: '#ffffff' }
                    },
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    color: '#a0a0a0',
                    range: [0, null]
                },
                yaxis: {
                    title: {
                        text: 'Cantidad de Posts',
                        font: { color: '#ffffff' }
                    },
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    color: '#a0a0a0'
                },
                plot_bgcolor: 'rgba(0, 0, 0, 0)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                showlegend: true,
                legend: {
                    font: { color: '#ffffff' },
                    bgcolor: 'rgba(255, 255, 255, 0.05)',
                    bordercolor: 'rgba(255, 255, 255, 0.1)',
                    borderwidth: 1
                },
                font: {
                    family: 'Outfit, sans-serif'
                },
                shapes: [
                    // Regi√≥n debajo del promedio (izquierda) - Rojo suave
                    {
                        type: 'rect',
                        xref: 'x',
                        yref: 'paper',
                        x0: 0,
                        x1: mean,
                        y0: 0,
                        y1: 1,
                        fillcolor: 'rgba(255, 100, 100, 0.05)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // Regi√≥n encima del promedio (derecha) - Verde suave
                    {
                        type: 'rect',
                        xref: 'x',
                        yref: 'paper',
                        x0: mean,
                        x1: max,
                        y0: 0,
                        y1: 1,
                        fillcolor: 'rgba(100, 255, 100, 0.05)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // L√≠nea vertical en el promedio
                    {
                        type: 'line',
                        xref: 'x',
                        yref: 'paper',
                        x0: mean,
                        x1: mean,
                        y0: 0,
                        y1: 1,
                        line: {
                            color: 'rgba(255, 253, 0, 0.8)',
                            width: 3,
                            dash: 'dash'
                        }
                    }
                ],
                annotations: [
                    {
                        x: mean,
                        y: 1,
                        yref: 'paper',
                        text: `Media: ${formatNumber(mean)}`,
                        showarrow: true,
                        arrowhead: 2,
                        arrowcolor: 'rgba(255, 253, 0, 0.8)',
                        font: {
                            color: '#FFFD00',
                            size: 12
                        },
                        bgcolor: 'rgba(0, 0, 0, 0.7)',
                        bordercolor: 'rgba(255, 253, 0, 0.8)',
                        borderwidth: 1
                    },
                    // Etiqueta "Debajo del Promedio"
                    {
                        x: mean / 2,
                        y: 0.95,
                        yref: 'paper',
                        text: '‚Üê Debajo del Promedio',
                        showarrow: false,
                        font: {
                            color: 'rgba(255, 100, 100, 0.8)',
                            size: 11
                        },
                        bgcolor: 'rgba(0, 0, 0, 0.5)',
                        bordercolor: 'rgba(255, 100, 100, 0.5)',
                        borderwidth: 1
                    },
                    // Etiqueta "Encima del Promedio"
                    {
                        x: mean + (max - mean) / 2,
                        y: 0.95,
                        yref: 'paper',
                        text: 'Encima del Promedio ‚Üí',
                        showarrow: false,
                        font: {
                            color: 'rgba(100, 255, 100, 0.8)',
                            size: 11
                        },
                        bgcolor: 'rgba(0, 0, 0, 0.5)',
                        bordercolor: 'rgba(100, 255, 100, 0.5)',
                        borderwidth: 1
                    }
                ]
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };

            // Renderizar gr√°fico
            Plotly.newPlot('postsVsLikesPlot', [histogramTrace], layout, config);

            // Generar tabla de Top Performers
            populateTopPerformers(filteredPosts, mean);
        }

        let currentSort = { column: 1, ascending: false }; // Default: sort by likes descending

        function populateTopPerformers(posts, mean) {
            const nbins = 30;
            const likesData = posts.map(p => p.likesCount || 0).filter(l => l > 0);
            const min = Math.min(...likesData);
            const max = Math.max(...likesData);
            const binWidth = (max - min) / nbins;

            const bins = [];
            for (let i = 0; i < nbins; i++) {
                const binStart = min + (i * binWidth);
                const binEnd = min + ((i + 1) * binWidth);
                bins.push({
                    range: `${formatNumber(binStart)} - ${formatNumber(binEnd)}`,
                    rangeStart: binStart,
                    rangeEnd: binEnd,
                    posts: [],
                    count: 0,
                    aboveMean: binEnd > mean
                });
            }

            posts.forEach(post => {
                if (!post.likesCount || post.likesCount <= 0) return;
                const binIndex = Math.min(Math.floor((post.likesCount - min) / binWidth), nbins - 1);
                bins[binIndex].posts.push({
                    date: new Date(post.timestamp),
                    likes: post.likesCount,
                    comments: post.commentsCount || 0,
                    ratio: (post.likesCount / mean).toFixed(2),
                    owner: post.ownerUsername || post.ownerFullName || 'Desconocido',
                    url: post.url || '#',
                    caption: (post.caption || 'Sin caption').substring(0, 50)
                });
                bins[binIndex].count++;
            });

            const binsWithPosts = bins.filter(bin => bin.count > 0).sort((a, b) => b.rangeStart - a.rangeStart);
            const totalPosts = posts.length;
            const postsAboveMean = binsWithPosts.filter(bin => bin.aboveMean).reduce((sum, bin) => sum + bin.count, 0);
            const percentageAbove = ((postsAboveMean / totalPosts) * 100).toFixed(1);

            document.getElementById('eliteStats').innerHTML = `
                <strong>${binsWithPosts.length}</strong> rangos | 
                <strong>${postsAboveMean}</strong> posts (<strong>${percentageAbove}%</strong>) 
                sobre media de <strong>${formatNumber(mean)}</strong> likes
            `;

            renderTable(binsWithPosts, mean);
        }

        function renderTable(bins, mean) {
            const tbody = document.getElementById('performersBody');

            if (bins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No hay posts</td></tr>';
                return;
            }

            let html = '';
            bins.forEach((bin, binIndex) => {
                const bgColor = bin.aboveMean ? 'rgba(100, 255, 100, 0.1)' : 'rgba(255, 100, 100, 0.1)';
                const textColor = bin.aboveMean ? '#00FF64' : '#FF6464';

                html += `
                    <tr style="background: ${bgColor}; cursor: pointer;" onclick="toggleBin(${binIndex})" class="bin-header">
                        <td colspan="7" style="font-weight: 600; color: ${textColor};">
                            üìä Rango: ${bin.range} likes 
                            <span style="color: var(--accent); margin-left: 1rem;">
                                (${bin.count} post${bin.count !== 1 ? 's' : ''})
                            </span>
                            <span style="float: right; color: var(--text-secondary);">‚ñº</span>
                        </td>
                    </tr>
                `;

                bin.posts.sort((a, b) => b.likes - a.likes).forEach(post => {
                    html += `
                        <tr class="bin-${binIndex}-post" style="display: none;">
                            <td style="padding-left: 2rem;">${post.date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
                            <td><strong>${formatNumber(post.likes)}</strong></td>
                            <td>${formatNumber(post.comments)}</td>
                            <td class="ratio-cell">${post.ratio}x</td>
                            <td style="color: var(--accent);">${post.owner}</td>
                            <td class="link-cell"><a href="${post.url}" target="_blank" title="Ver post en Instagram">üîó Ver Post</a></td>
                            <td class="caption-cell" title="${post.caption}">${post.caption}...</td>
                        </tr>
                    `;
                });
            });

            tbody.innerHTML = html;
        }

        function toggleBin(binIndex) {
            const posts = document.querySelectorAll(`.bin-${binIndex}-post`);
            const headers = document.querySelectorAll('.bin-header');
            const header = headers[binIndex];
            const arrow = header.querySelector('span[style*="float: right"]');

            const isHidden = posts[0].style.display === 'none';
            posts.forEach(post => {
                post.style.display = isHidden ? 'table-row' : 'none';
            });
            arrow.textContent = isHidden ? '‚ñ≤' : '‚ñº';
        }

        function sortTable(columnIndex) {
            const tbody = document.getElementById('performersBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction if same column
            if (currentSort.column === columnIndex) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = columnIndex;
                currentSort.ascending = false;
            }

            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();

                // Parse numbers for numeric columns
                let aNum, bNum;
                if (columnIndex === 1 || columnIndex === 2) { // Likes or Comments
                    aNum = parseFloat(aValue.replace(/[KM]/g, '')) * (aValue.includes('K') ? 1000 : aValue.includes('M') ? 1000000 : 1);
                    bNum = parseFloat(bValue.replace(/[KM]/g, '')) * (bValue.includes('K') ? 1000 : bValue.includes('M') ? 1000000 : 1);
                } else if (columnIndex === 3) { // Ratio
                    aNum = parseFloat(aValue);
                    bNum = parseFloat(bValue);
                } else if (columnIndex === 0) { // Date
                    aNum = new Date(aValue).getTime();
                    bNum = new Date(bValue).getTime();
                } else {
                    return currentSort.ascending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                }

                return currentSort.ascending ? aNum - bNum : bNum - aNum;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.round(num).toString();
        }

        // Initialize
        loadData();
    </script>
</body>

</html>